= General Transit Feed Specification (GTFS) Neo4j Importer
v1.2, 2016-02-15
:library: Asciidoctor
:include:
:idprefix:
:numbered:
:imagesdir: docs
:toc: manual
:css-signature: demo
:toc-placement: preamble
:toc:
:icons: font
:source-highlighter: prettify
:project_id: neo4j-gtfs
:sectanchors: ad


---

== Project Overview

This project is a showcase of spring-data, neo4j, rest and hateoas.

The Spring Boot based application provides the following features:

* Performs an unattended download of General Transit Feed Specification (GTFS) data
from New Jersey Transit.

* Loads the downloaded GTFS files into Neo4j.

* Provides web services, such as a trip planner API, to allow you to interact with the data.

You need an account as an NJ transit developer.
You can sign up https://www.njtransit.com/mt/mt_servlet.srv?hdnPageAction=MTDevLoginTo[here].

This project is largely derived off the work that was done by
http://blog.bruggen.com/p/about-author.html[Rick Van Bruggen] (github account https://github.com/rvanbruggen[rvanbruggen])

Loading the data is based off his blog entry http://blog.bruggen.com/2015/11/loading-general-transport-feed-spec.html["Loading General Transport Feed Spec (GTFS) files into Neo4j - part 1/2"]

Querying the data is based off his blog entry http://blog.bruggen.com/2015/11/querying-gtfs-data-using-neo4j-23-part.html["Querying GTFS data - using Neo4j 2.3 - part 2/2"]

== What you'll need

:java_version: 1.8

//include::docs/prereq_editor_jdk_buildtools.adoc[]

//
:linkattrs:

ifndef::java_version[:java_version: 1.6]

* About 15 minutes
* A favorite text editor or IDE
* http://www.oracle.com/technetwork/java/javase/downloads/index.html[JDK {java_version}] or later
* http://www.gradle.org/downloads[Gradle 2.3+] or http://maven.apache.org/download.cgi[Maven 3.0+]
* You can also import the code straight into your IDE:
** link:/guides/gs/sts[Spring Tool Suite (STS)]
** link:/guides/gs/intellij-idea/[IntelliJ IDEA]
//

//include::docs/how_to_complete_this_guide.adoc[]

//include::docs/hide-show-gradle.adoc[]

//include::docs/hide-show-maven.adoc[]

//include::https://raw.githubusercontent.com/spring-guides/getting-started-macros/master/hide-show-sts.adoc[]

== Standing up a Neo4j server

Before you can build a this application, you need to set up a Neo4j server.

Neo4j has an open source server you can install for free:

On a Mac, just type:

----
$ brew install neo4j
----

Also on a mac, make sure the Neo4j imports folder has proper write permissions.
This should take care of it:

----
chmod -R g+w /usr/local/Cellar/neo4j/3.1.4/libexec/import
----

For other options, visit https://neo4j.com/download/community-edition/

Once you installed, launch it with it's default settings:

----
$ neo4j start
----

You should see a message like this:

....
Starting Neo4j.
Started neo4j (pid 96416). By default, it is available at http://localhost:7474/
There may be a short delay until the server is ready.
See /usr/local/Cellar/neo4j/3.0.6/libexec/logs/neo4j.log for current status.
....

By default, Neo4j has a username/password of neo4j/neo4j. However, it requires that the new account password be changed. To do so, execute the following command:

----
$ curl -v -u neo4j:neo4j -X POST localhost:7474/user/neo4j/password -H "Content-type:application/json" -d "{\"password\":\"secret\"}"
----

This changes the password from *neo4j* to *secret* (something to NOT DO in production!) With that completed, you should be ready to run this guide.


[[initial]]
== Permissions to access Neo4j and the NJ Transit Website

Neo4j Community Edition requires credentials to access it. This can be configured with a couple of properties.

["source","java",tab="8",args="--line-range=1-2"]
----
spring.data.neo4j.username=neo4j
spring.data.neo4j.password=secret
----
//include::complete/src/main/resources/application.properties[lines=1;1..2]

Similarly, your login to download the GTFS files from the New Jersey Transit website are stored in this file.

["source","java",tab="8",args="--line-range=-4"]
----
njgtfs.login=foo
njgtfs.password=bar
----
//include::complete/src/main/resources/application.properties[lines=4;3..4]

This includes the default username `neo4j` and the newly set password `secret` we picked earlier.

WARNING: Do NOT store real credentials in your source repository. Instead, configure them in your runtime using http://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-external-config[Spring Boot's property overrides].

With this in place, let's load up the data and interact with it.


//include::docs/build_an_executable_jar_subhead.adoc[]
//include::docs/build_an_executable_jar_with_both.adoc[]

//
== Build an executable JAR

:linkattrs:

You can run the application from the command line with Gradle or Maven. Or you can build a single executable JAR file that contains all the necessary dependencies, classes, and resources, and run that. This makes it easy to ship, version, and deploy the service as an application throughout the development lifecycle, across different environments, and so forth.

If you are using Gradle, you can run the application using `./gradlew bootRun`.  Or you can build the JAR file using `./gradlew build`. Then you can run the JAR file:

[subs="attributes", role="has-copy-button"]
....
java -jar build/libs/{project_id}-0.1.0.jar
....

If you are using Maven, you can run the application using `./mvnw spring-boot:run`. Or you can build the JAR file with `./mvnw clean package`. Then you can run the JAR file:

[subs="attributes", role="has-copy-button"]
....
java -jar target/{project_id}-0.1.0.jar
....

NOTE: The procedure above will create a runnable JAR. You can also opt to link:https://spring.io/guides/gs/convert-jar-to-war/[build a classic WAR file] instead.



//

////
Non widnows systems:

----
cd complete
./gradlew bootRun
----

Windows systems
----
cd complete
.\gradlew.bat bootRun
----
////

The server comes up on http://localhost:8080 by default.

== Loading the data

Two endpoints are provided:

* Dowload and import the data fully automated: +
http://localhost:8080/customrest/LoadData

* Import a predownloaded zip file and place it in the same directory as the Spring Boot app server (default filename rail_data.zip).
Then initiate importing it into Neo4j by calling this URL: +
http://localhost:8080/customrest/LoadPrefetched

== Interact with the data via Spring-Data-Rest

By default all the endpoints exposed via spring-data-rest are left in place.
You can traverse through those by accessing the root of the app server.:

http://localhost:8080/

To understand how this works, read the page https://spring.io/understanding/HATEOAS[Understanding HATEOS] prepared by the
Spring community.

== Interact with the data via custom web services

The application also exposes web services hosting custom cypher queries for trip planning.
Currently only one such endpoint exists, and it is purpose built to provide
trip options from one station to another given departure and arrival time criteria:

curltests/planTrip.sh
----
#!/usr/bin/env bash
curl -H "Content-Type: application/json" -X POST --data @TripPlan1.json http://localhost:8080/customrest/plantrip
----
//include::curltests/planTrip.sh[]


curltests/TripPlan1.json
----
{
               "serviceId":"4",
               "origStation":"WESTWOOD",
               "origArrivalTimeLow" :"06:30:00",
               "origArrivalTimeHigh" :"07:10:00",
               "destStation" :"HOBOKEN",
               "destArrivalTimeLow":"06:30:00",
               "destArrivalTimeHigh":"08:00:00"
}
----
//include::curltests/TripPlan1.json[]

== Interact with the data using Cypher

Open your browser to Neo4j's own Cypher query tool by opening your browser to http://localhost:7474/ and start writing
cypher queries like the ones below

----
//find a DIRECT route with range conditions
MATCH
  (orig:Stop {name: "WESTWOOD"})--(orig_st:Stoptime)-[r1:PART_OF_TRIP]->(trp:Trip)
WHERE
  orig_st.departure_time > "06:30:00"
  AND orig_st.departure_time < "07:10:00"
  AND trp.service_id="4"
WITH
  orig, orig_st
MATCH
    (dest:Stop {name:"HOBOKEN"})--(dest_st:Stoptime)-[r2:PART_OF_TRIP]->(trp2:Trip)
WHERE
    dest_st.arrival_time < "08:00:00"
    AND dest_st.arrival_time > "07:00:00"
    AND dest_st.arrival_time > orig_st.departure_time
    AND trp2.service_id="4"
WITH
    dest,dest_st,orig, orig_st
MATCH
    p = allshortestpaths((orig_st)-[*]->(dest_st))
WITH
    nodes(p) as n
UNWIND
    n as nodes
//MATCH
//  p=((nodes)-[loc:LOCATED_AT]->(stp:Stop))
OPTIONAL MATCH
    p=(nodes)-[r:PRECEDES|LOCATED_AT]->(next)
RETURN
    p, COALESCE(nodes.stop_sequence, next.stop_sequence AS stopSequence
ORDER BY stopSequence;
----

image::route_and_stops_direct.png[route_and_stops]


----
//plan a specific indirect route
MATCH
    (orig:Stop {name:"WESTWOOD"})--(st_orig:Stoptime),
    (dest:Stop {name:"HOBOKEN"})--(st_dest:Stoptime),
    p1=((st_orig)-[:PRECEDES*]->(st_midway_arr:Stoptime)),
    (st_midway_arr)--(midway:Stop),
    (midway)--(st_midway_dep:Stoptime),
    p2=((st_midway_dep)-[:PRECEDES*]->(st_dest))
WHERE
    st_orig.departure_time > "08:00:00"
    AND st_orig.departure_time < "11:00:00"
    AND st_midway_arr.arrival_time > st_orig.departure_time
    AND st_midway_dep.departure_time > st_midway_arr.arrival_time
    AND st_dest.arrival_time > st_midway_dep.departure_time
RETURN
    orig,st_orig,dest,st_dest,p1,p2,midway
ORDER BY
    (st_dest.arrival_time_int-st_orig.departure_time_int) ASC
LIMIT 1;
----

image::route_and_stops_indirect.png[route_and_stops]

== Create your own services

Add new queries to the repository com.popameeting.gtfs.neo4j.repository and interact with them via Spring-Data-Rest's
provided web services - if you need the data presented differently see the projections in
com.popameeting.gtfs.neo4j.entity.projection and how they are being used in the URL above.



